<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kartu Anggota | Mahapala Narotama</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      scroll-behavior: smooth;
      background-color: #f8f9fa;
    }
    section {
      margin-top: 80px;
      padding-bottom: 60px;
    }
    h1, h2, h4 {
      color: #2f4f4f;
    }
    /* Styling untuk search bar */
    .search-container {
      margin-bottom: 20px;
    }
    .qrcode {
      cursor: pointer;
    }
    /* Styling foto kartu anggota (untuk tampilan desktop) */
    .member-photo {
      max-width: 500px;
      margin: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    /* Tampilan tabel dan foto untuk desktop */
    #anggotaTable, #memberPhotos {
      display: block;
    }
    /* Tampilan kartu untuk mobile (seluler) */
    #anggotaCards {
      display: none;
    }
    /* Media Query: untuk layar kecil (handphone) */
    @media (max-width: 767px) {
      #anggotaTable, #memberPhotos {
        display: none;
      }
      #anggotaCards {
        display: block;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">MAHAPALA NAROTAMA</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
              aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarContent">
         <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Beranda</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="kegiatan.html">Kegiatan</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="pembelajaran.html">Pembelajaran</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="kartuanggota.html">Kartu Anggota</a>
            </li>
         </ul>
      </div>
    </div>
  </nav>

  <!-- Section: Kartu Anggota -->
  <section id="anggota" class="py-5">
    <div class="container">
      <h2 class="mb-4">Kartu Anggota</h2>
      <p>Data anggota yang hanya dapat diakses melalui link khusus.</p>

      <!-- Search Bar -->
      <div class="row search-container">
        <div class="col-md-3">
          <select id="searchType" class="form-select">
            <option value="namalengkap">Nama Lengkap</option>
            <option value="namalapangan">Nama Lapangan</option>
            <option value="namaangkatan">Nama Angkatan</option>
            <option value="tahun">Tahun Angkatan</option>
            <option value="nomorregistrasi">Nomor Registrasi</option>
            <option value="keanggotaan">Keanggotaan</option>
          </select>
        </div>
        <div class="col-md-7">
          <input type="text" id="searchInput" class="form-control" placeholder="Cari...">
        </div>
        <div class="col-md-2">
          <button id="searchBtn" class="btn btn-success w-100">Cari</button>
        </div>
      </div>

      <!-- Tampilan Tabel Data Anggota (Desktop) -->
      <table class="table table-striped" id="anggotaTable">
        <thead>
          <tr>
            <th>Nama Lengkap</th>
            <th>Nama Lapangan</th>
            <th>Nama Angkatan</th>
            <th>Tahun Angkatan</th>
            <th>Nomor Registrasi</th>
            <th>Keanggotaan</th>
            <th>QR Code</th>
          </tr>
        </thead>
        <tbody id="anggotaTableBody">
          <!-- Data akan dimuat dari Firestore, namun default disembunyikan -->
        </tbody>
      </table>

      <!-- Tampilan Foto Kartu Anggota (Desktop) -->
      <div class="mt-5" id="memberPhotos">
        <!-- Foto akan diisi secara dinamis melalui JS berdasarkan baris yang tampil -->
      </div>

      <!-- Tampilan Card untuk Mobile -->
      <div class="mt-5" id="anggotaCards">
        <!-- Card anggota akan diisi secara dinamis melalui JS berdasarkan baris yang tampil -->
      </div>
    </div>
  </section>

  <!-- Modal Fullscreen untuk Tampilan Gambar -->
  <div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="photoModalLabel">Kartu Anggota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="modalImage" src="" alt="Kartu Anggota" class="img-fluid">
        </div>
        <div class="modal-footer">
          <a id="downloadButton" href="#" download class="btn btn-primary">Download</a>
          <button id="shareButton" type="button" class="btn btn-secondary">Bagikan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase and QRCode Integration -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    // Firebase configuration (pastikan konfigurasi sesuai project kamu)
    const firebaseConfig = {
      apiKey: "AIzaSyBe-XLmVRiMs844VxR1_awMzGEGARb6Xmk",
      authDomain: "website-mpn-65e8d.firebaseapp.com",
      projectId: "website-mpn-65e8d",
      storageBucket: "website-mpn-65e8d.appspot.com",
      messagingSenderId: "798271486726",
      appId: "1:798271486726:web:0d0e0178a963804f627c87",
      measurementId: "G-KSVPVC1Z9D"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // Fungsi untuk mengambil data anggota dari Firestore dan menyusun tabel
    async function loadAnggotaData() {
      const anggotaTableBody = document.getElementById("anggotaTableBody");
      anggotaTableBody.innerHTML = ""; // Bersihkan tabel

      try {
        const querySnapshot = await getDocs(collection(db, "anggota"));
        console.log("Jumlah dokumen: ", querySnapshot.size);
        querySnapshot.forEach(doc => {
          const data = doc.data();
          console.log("Data anggota:", data);
          const row = document.createElement("tr");
          // Simpan nilai asli untuk pencarian
          row.setAttribute("data-namalengkap", data.namalengkap.toString());
          row.setAttribute("data-namalapangan", data.namalapangan.toString());
          row.setAttribute("data-namaangkatan", data.namaangkatan.toString());
          row.setAttribute("data-tahun", data.tahun.toString());
          row.setAttribute("data-nomorregistrasi", data.nomorregistrasi.toString());
          row.setAttribute("data-keanggotaan", data.keanggotaan.toString());
          // Pastikan field foto tersimpan dengan benar
          row.setAttribute("data-foto", data.foto ? data.foto.toString() : "");
          row.innerHTML = `
            <td>${data.namalengkap}</td>
            <td>${data.namalapangan}</td>
            <td>${data.namaangkatan}</td>
            <td>${data.tahun}</td>
            <td>${data.nomorregistrasi}</td>
            <td>${data.keanggotaan}</td>
            <td>
              <canvas id="qr-${data.nomorregistrasi}" class="qrcode"></canvas>
            </td>
          `;
          // Sembunyikan baris secara default
          row.style.display = "none";
          anggotaTableBody.appendChild(row);
        });
        generateQRCodes();
        updateMemberPhotos();
        updateAnggotaCards();
      } catch (error) {
        console.error("Error mengambil data:", error);
      }
    }

    // Fungsi untuk menghasilkan QR Code untuk setiap baris (desktop)
    // QR code dihasilkan dari URL foto (data-foto)
    function generateQRCodes() {
      const rows = document.querySelectorAll("#anggotaTable tbody tr");
      rows.forEach(row => {
        const foto = row.getAttribute("data-foto");
        const nomor = row.getAttribute("data-nomorregistrasi");
        const canvasElement = document.getElementById("qr-" + nomor);
        if (canvasElement && foto && foto.trim() !== "") {
          QRCode.toCanvas(canvasElement, foto, {
            width: 80,
            margin: 1
          }, function (error) {
            if (error) console.error(error);
          });
          // Tambahkan event listener agar ketika QR code diklik, modal tampil
          canvasElement.addEventListener("click", function() {
            const modalImage = document.getElementById("modalImage");
            modalImage.src = foto;
            const downloadButton = document.getElementById("downloadButton");
            downloadButton.href = foto;
            const photoModal = new bootstrap.Modal(document.getElementById("photoModal"));
            photoModal.show();
          });
        }
      });
    }

    // Fungsi untuk memperbarui tampilan foto (desktop)
    function updateMemberPhotos() {
      const rows = document.querySelectorAll("#anggotaTable tbody tr");
      const photoContainer = document.getElementById("memberPhotos");
      photoContainer.innerHTML = "";
      rows.forEach(row => {
        if (row.style.display !== "none") {
          const foto = row.getAttribute("data-foto");
          const nama = row.getAttribute("data-namalengkap");
          if(foto && foto.trim() !== ""){
            const img = document.createElement("img");
            img.src = foto;
            img.alt = "Kartu Anggota " + nama;
            img.className = "member-photo";
            img.onerror = function() {
              console.error("Gagal memuat gambar: " + foto);
            };
            photoContainer.appendChild(img);
          } else {
            console.error("Tidak ada URL gambar untuk: " + nama);
          }
        }
      });
    }

    // Fungsi untuk memperbarui tampilan kartu anggota (mobile)
    function updateAnggotaCards() {
      const rows = document.querySelectorAll("#anggotaTable tbody tr");
      const cardContainer = document.getElementById("anggotaCards");
      cardContainer.innerHTML = "";
      rows.forEach(row => {
        if (row.style.display !== "none") {
          const namalengkap = row.getAttribute("data-namalengkap");
          const namalapangan = row.getAttribute("data-namalapangan");
          const namaangkatan = row.getAttribute("data-namaangkatan");
          const tahun = row.getAttribute("data-tahun");
          const nomorregistrasi = row.getAttribute("data-nomorregistrasi");
          const keanggotaan = row.getAttribute("data-keanggotaan");
          const foto = row.getAttribute("data-foto");
          const link = row.querySelector("a") ? row.querySelector("a").href : "#";

          const card = document.createElement("div");
          card.className = "card mb-3";
          card.innerHTML = `
            <img src="${foto}" class="card-img-top" alt="Kartu Anggota ${namalengkap}">
            <div class="card-body">
              <h5 class="card-title">${namalengkap}</h5>
              <p class="card-text">
                <strong>Nama Lapangan:</strong> ${namalapangan}<br>
                <strong>Nama Angkatan:</strong> ${namaangkatan}<br>
                <strong>Tahun:</strong> ${tahun}<br>
                <strong>Nomor Registrasi:</strong> ${nomorregistrasi}<br>
                <strong>Keanggotaan:</strong> ${keanggotaan}
              </p>
            </div>
            <div class="card-footer">
              <canvas id="qr-mobile-${nomorregistrasi}" class="qrcode"></canvas>
            </div>
          `;
          cardContainer.appendChild(card);
        }
      });
      generateQRCodesMobile();
    }

    // Fungsi untuk menghasilkan QR Code pada tampilan mobile
    function generateQRCodesMobile() {
      const rows = document.querySelectorAll("#anggotaTable tbody tr");
      rows.forEach(row => {
        if (row.style.display !== "none") {
          const nomor = row.getAttribute("data-nomorregistrasi");
          const canvasElement = document.getElementById("qr-mobile-" + nomor);
          const foto = row.getAttribute("data-foto");
          if (canvasElement && foto && foto.trim() !== "") {
            QRCode.toCanvas(canvasElement, foto, {
              width: 80,
              margin: 1
            }, function (error) {
              if (error) console.error(error);
            });
            canvasElement.addEventListener("click", function() {
              const modalImage = document.getElementById("modalImage");
              modalImage.src = foto;
              const downloadButton = document.getElementById("downloadButton");
              downloadButton.href = foto;
              const photoModal = new bootstrap.Modal(document.getElementById("photoModal"));
              photoModal.show();
            });
          }
        }
      });
    }

    // Fungsi pencarian: tampilkan data hanya ketika ada input pencarian
    function filterTable() {
      const searchType = document.getElementById("searchType").value;
      const query = document.getElementById("searchInput").value.toLowerCase().trim();
      const rows = document.querySelectorAll("#anggotaTable tbody tr");
      
      if (query === "") {
        rows.forEach(row => row.style.display = "none");
      } else {
        rows.forEach(row => {
          const data = row.getAttribute("data-" + searchType).toLowerCase();
          row.style.display = data.includes(query) ? "" : "none";
        });
      }
      updateMemberPhotos();
      updateAnggotaCards();
    }

    // Fungsi untuk menangkap parameter URL (jika ingin mengisi pencarian otomatis)
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      const type = params.get("type");  
      const input = params.get("input"); 
      
      if (type && input) {
        document.getElementById("searchType").value = type;
        document.getElementById("searchInput").value = input;
        filterTable();
      }
    }

    // Event listener
    document.addEventListener("DOMContentLoaded", () => {
      loadAnggotaData().then(() => {
        getQueryParams();
      });
      document.getElementById("searchBtn").addEventListener("click", filterTable);
      document.getElementById("searchInput").addEventListener("keyup", filterTable);

      // Tambahkan event listener untuk tombol Bagikan pada modal
      document.getElementById("shareButton").addEventListener("click", function() {
        const modalImage = document.getElementById("modalImage");
        const imageUrl = modalImage.src;
        if (navigator.share) {
          navigator.share({
            title: "Kartu Anggota Mahapala Narotama",
            text: "Lihat kartu anggota ini!",
            url: imageUrl
          })
          .then(() => console.log("Berhasil membagikan"))
          .catch(error => console.error("Gagal membagikan:", error));
        } else {
          alert("Fitur share tidak didukung di browser ini.");
        }
      });
    });
    
  </script>
  <!-- QRCode.js -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
